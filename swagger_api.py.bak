"""
CRM & Inventory API with Swagger Documentation
Run: python swagger_api.py
Access Swagger UI at: http://localhost:5000/apidocs
"""
import os
os.environ['FLASK_ENV'] = 'development'

from flask import Flask, jsonify, request
from flasgger import Swagger, swag_from

app = Flask(__name__)

# Swagger configuration
swagger_config = {
    "headers": [],
    "specs": [
        {
            "endpoint": 'apispec',
            "route": '/apispec.json',
            "rule_filter": lambda rule: True,
            "model_filter": lambda tag: True,
        }
    ],
    "static_url_path": "/flasgger_static",
    "swagger_ui": True,
    "specs_route": "/apidocs/"
}

swagger_template = {
    "swagger": "2.0",
    "info": {
        "title": "CRM & Inventory Management API",
        "description": "RESTful API for managing customers, products, orders, and inventory",
        "contact": {
            "email": "api-support@example.com"
        },
        "version": "1.0.0"
    },
    "host": "localhost:5000",
    "basePath": "/",
    "schemes": ["http"],
    "tags": [
        {
            "name": "Health",
            "description": "Health check endpoints"
        },
        {
            "name": "Customers",
            "description": "Customer management operations"
        },
        {
            "name": "Products",
            "description": "Product catalog operations"
        },
        {
            "name": "Orders",
            "description": "Order management operations"
        },
        {
            "name": "Analytics",
            "description": "Advanced analytics and reporting operations"
        }
    ]
}

swagger = Swagger(app, config=swagger_config, template=swagger_template)

# Health Check
@app.route('/health', methods=['GET'])
def health():
    """
    Health Check Endpoint
    ---
    tags:
      - Health
    responses:
      200:
        description: API is healthy and running
        schema:
          type: object
          properties:
            status:
              type: string
              example: healthy
            message:
              type: string
              example: API is running
    """
    return jsonify({'status': 'healthy', 'message': 'API is running'}), 200

# Customer Endpoints
@app.route('/api/customers', methods=['GET'])
def get_customers():
    """
    Get All Customers
    ---
    tags:
      - Customers
    parameters:
      - name: page
        in: query
        type: integer
        required: false
        default: 1
        description: Page number for pagination
      - name: limit
        in: query
        type: integer
        required: false
        default: 50
        description: Number of items per page
      - name: status
        in: query
        type: string
        required: false
        description: Filter by customer status
    responses:
      200:
        description: List of customers retrieved successfully
        schema:
          type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
                  name:
                    type: string
                    example: John Doe
                  email:
                    type: string
                    example: john@example.com
            total:
              type: integer
              example: 2
            page:
              type: integer
              example: 1
    """
    page = request.args.get('page', 1, type=int)
    limit = request.args.get('limit', 50, type=int)
    
    return jsonify({
        'data': [
            {'id': 1, 'name': 'John Doe', 'email': 'john@example.com', 'status': 'active'},
            {'id': 2, 'name': 'Jane Smith', 'email': 'jane@example.com', 'status': 'active'}
        ],
        'total': 2,
        'page': page,
        'limit': limit
    }), 200

@app.route('/api/customers/<int:customer_id>', methods=['GET'])
def get_customer(customer_id):
    """
    Get Customer by ID
    ---
    tags:
      - Customers
    parameters:
      - name: customer_id
        in: path
        type: integer
        required: true
        description: Customer ID
    responses:
      200:
        description: Customer details retrieved successfully
        schema:
          type: object
          properties:
            id:
              type: integer
              example: 1
            name:
              type: string
              example: John Doe
            email:
              type: string
              example: john@example.com
            phone:
              type: string
              example: 555-0123
            company:
              type: string
              example: Acme Corp
            address:
              type: string
              example: 123 Main St
            status:
              type: string
              example: active
      404:
        description: Customer not found
    """
    return jsonify({
        'id': customer_id,
        'name': 'John Doe',
        'email': 'john@example.com',
        'phone': '555-0123',
        'company': 'Acme Corp',
        'address': '123 Main St, City, State 12345',
        'status': 'active',
        'created_at': '2024-01-15T10:30:00Z'
    }), 200

@app.route('/api/customers', methods=['POST'])
def create_customer():
    """
    Create New Customer
    ---
    tags:
      - Customers
    parameters:
      - name: body
        in: body
        required: true
        schema:
          type: object
          required:
            - name
            - email
          properties:
            name:
              type: string
              example: John Doe
            email:
              type: string
              example: john@example.com
            phone:
              type: string
              example: 555-0123
            company:
              type: string
              example: Acme Corp
            address:
              type: string
              example: 123 Main St
    responses:
      201:
        description: Customer created successfully
        schema:
          type: object
          properties:
            id:
              type: integer
              example: 3
            message:
              type: string
              example: Customer created successfully
      400:
        description: Invalid input data
    """
    data = request.get_json()
    return jsonify({
        'id': 3,
        'message': 'Customer created successfully',
        'data': data
    }), 201

# Product Endpoints
@app.route('/api/products', methods=['GET'])
def get_products():
    """
    Get All Products
    ---
    tags:
      - Products
    parameters:
      - name: page
        in: query
        type: integer
        required: false
        default: 1
        description: Page number
      - name: limit
        in: query
        type: integer
        required: false
        default: 50
        description: Items per page
      - name: category
        in: query
        type: string
        required: false
        description: Filter by category
    responses:
      200:
        description: List of products
        schema:
          type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  price:
                    type: number
                  stock:
                    type: integer
            total:
              type: integer
            page:
              type: integer
    """
    page = request.args.get('page', 1, type=int)
    limit = request.args.get('limit', 50, type=int)
    
    return jsonify({
        'data': [
            {'id': 1, 'name': 'Widget A', 'price': 29.99, 'stock': 100, 'category': 'Electronics'},
            {'id': 2, 'name': 'Widget B', 'price': 49.99, 'stock': 50, 'category': 'Electronics'}
        ],
        'total': 2,
        'page': page,
        'limit': limit
    }), 200

@app.route('/api/products/<int:product_id>', methods=['GET'])
def get_product(product_id):
    """
    Get Product by ID
    ---
    tags:
      - Products
    parameters:
      - name: product_id
        in: path
        type: integer
        required: true
        description: Product ID
    responses:
      200:
        description: Product details
        schema:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            price:
              type: number
            stock:
              type: integer
            category:
              type: string
            description:
              type: string
      404:
        description: Product not found
    """
    return jsonify({
        'id': product_id,
        'name': 'Widget A',
        'price': 29.99,
        'stock': 100,
        'category': 'Electronics',
        'description': 'High-quality electronic widget',
        'sku': 'WGT-A-001'
    }), 200

@app.route('/api/products', methods=['POST'])
def create_product():
    """
    Create New Product
    ---
    tags:
      - Products
    parameters:
      - name: body
        in: body
        required: true
        schema:
          type: object
          required:
            - name
            - price
            - stock
          properties:
            name:
              type: string
              example: Widget C
            price:
              type: number
              example: 39.99
            stock:
              type: integer
              example: 75
            category:
              type: string
              example: Electronics
            description:
              type: string
              example: New electronic widget
    responses:
      201:
        description: Product created successfully
      400:
        description: Invalid input
    """
    data = request.get_json()
    return jsonify({
        'id': 3,
        'message': 'Product created successfully',
        'data': data
    }), 201

# Order Endpoints
@app.route('/api/orders', methods=['GET'])
def get_orders():
    """
    Get All Orders
    ---
    tags:
      - Orders
    parameters:
      - name: page
        in: query
        type: integer
        required: false
        default: 1
      - name: limit
        in: query
        type: integer
        required: false
        default: 50
      - name: status
        in: query
        type: string
        required: false
        description: Filter by order status (pending, completed, cancelled)
      - name: customer_id
        in: query
        type: integer
        required: false
        description: Filter by customer ID
    responses:
      200:
        description: List of orders
        schema:
          type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: integer
                  customer_id:
                    type: integer
                  total:
                    type: number
                  status:
                    type: string
            total:
              type: integer
            page:
              type: integer
    """
    page = request.args.get('page', 1, type=int)
    limit = request.args.get('limit', 50, type=int)
    
    return jsonify({
        'data': [
            {'id': 1, 'customer_id': 1, 'total': 299.99, 'status': 'completed', 'order_date': '2024-02-01'},
            {'id': 2, 'customer_id': 2, 'total': 149.99, 'status': 'pending', 'order_date': '2024-02-05'}
        ],
        'total': 2,
        'page': page,
        'limit': limit
    }), 200

@app.route('/api/orders/<int:order_id>', methods=['GET'])
def get_order(order_id):
    """
    Get Order by ID
    ---
    tags:
      - Orders
    parameters:
      - name: order_id
        in: path
        type: integer
        required: true
        description: Order ID
    responses:
      200:
        description: Order details with items
        schema:
          type: object
          properties:
            id:
              type: integer
            customer_id:
              type: integer
            total:
              type: number
            status:
              type: string
            items:
              type: array
              items:
                type: object
                properties:
                  product_id:
                    type: integer
                  quantity:
                    type: integer
                  price:
                    type: number
      404:
        description: Order not found
    """
    return jsonify({
        'id': order_id,
        'customer_id': 1,
        'total': 299.99,
        'status': 'completed',
        'order_date': '2024-02-01T14:30:00Z',
        'items': [
            {'product_id': 1, 'product_name': 'Widget A', 'quantity': 2, 'price': 29.99, 'subtotal': 59.98},
            {'product_id': 2, 'product_name': 'Widget B', 'quantity': 4, 'price': 49.99, 'subtotal': 199.96}
        ],
        'shipping_address': '123 Main St, City, State 12345',
        'payment_method': 'Credit Card'
    }), 200

@app.route('/api/orders', methods=['POST'])
def create_order():
    """
    Create New Order
    ---
    tags:
      - Orders
    parameters:
      - name: body
        in: body
        required: true
        schema:
          type: object
          required:
            - customer_id
            - items
          properties:
            customer_id:
              type: integer
              example: 1
            items:
              type: array
              items:
                type: object
                properties:
                  product_id:
                    type: integer
                    example: 1
                  quantity:
                    type: integer
                    example: 2
            shipping_address:
              type: string
              example: 123 Main St
            payment_method:
              type: string
              example: Credit Card
    responses:
      201:
        description: Order created successfully
      400:
        description: Invalid input
    """
    data = request.get_json()
    return jsonify({
        'id': 3,
        'message': 'Order created successfully',
        'data': data,
        'total': 299.99
    }), 201

if __name__ == '__main__':
    port = int(os.getenv('PORT', 5000))
    print(f"\n{'='*70}")
    print(f"ðŸš€ CRM & Inventory API with Swagger Documentation")
    print(f"{'='*70}")
    print(f"Server:        http://localhost:{port}")
    print(f"Swagger UI:    http://localhost:{port}/apidocs/")
    print(f"API Spec:      http://localhost:{port}/apispec.json")
    print(f"{'='*70}\n")
    
    app.run(host='0.0.0.0', port=port, debug=True)


# Analytics & Reporting Endpoints

@app.route('/api/analytics/customers', methods=['GET'])
def get_customer_analytics():
    """
    Customer Analytics Report
    ---
    tags:
      - Analytics
    parameters:
      - name: customer_id
        in: query
        type: integer
        required: false
        description: Filter by specific customer ID
      - name: start_date
        in: query
        type: string
        format: date
        required: false
        description: Start date for analysis (YYYY-MM-DD)
      - name: end_date
        in: query
        type: string
        format: date
        required: false
        description: End date for analysis (YYYY-MM-DD)
    responses:
      200:
        description: Customer analytics with revenue, orders, and payment stats
        schema:
          type: array
          items:
            type: object
            properties:
              customer_id:
                type: integer
              company_name:
                type: string
              total_orders:
                type: integer
              total_revenue:
                type: number
              avg_order_value:
                type: number
              outstanding_balance:
                type: number
              last_order_date:
                type: string
    """
    customer_id = request.args.get('customer_id', type=int)
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    
    # Mock data
    return jsonify([
        {
            'customer_id': 1,
            'company_name': 'Acme Corp',
            'customer_type': 'corporate',
            'credit_limit': 50000.00,
            'total_orders': 45,
            'total_revenue': 125000.50,
            'avg_order_value': 2777.79,
            'total_invoices': 45,
            'total_paid': 120000.00,
            'outstanding_balance': 5000.50,
            'total_payments': 42,
            'last_order_date': '2024-02-01',
            'last_payment_date': '2024-02-03'
        },
        {
            'customer_id': 2,
            'company_name': 'Tech Solutions Inc',
            'customer_type': 'corporate',
            'credit_limit': 75000.00,
            'total_orders': 62,
            'total_revenue': 185000.00,
            'avg_order_value': 2983.87,
            'total_invoices': 62,
            'total_paid': 180000.00,
            'outstanding_balance': 5000.00,
            'total_payments': 58,
            'last_order_date': '2024-02-04',
            'last_payment_date': '2024-02-05'
        }
    ]), 200

@app.route('/api/analytics/inventory-status', methods=['GET'])
def get_inventory_status():
    """
    Inventory Status Report
    ---
    tags:
      - Analytics
    responses:
      200:
        description: Comprehensive inventory status with reorder alerts
        schema:
          type: array
          items:
            type: object
            properties:
              product_id:
                type: integer
              product_name:
                type: string
              warehouse_name:
                type: string
              quantity_available:
                type: integer
              reorder_level:
                type: integer
              stock_status:
                type: string
                enum: [REORDER_NEEDED, LOW_STOCK, ADEQUATE]
              supplier_name:
                type: string
    """
    return jsonify([
        {
            'product_id': 1,
            'product_code': 'WGT-A-001',
            'product_name': 'Widget A',
            'category': 'Electronics',
            'unit_price': 29.99,
            'warehouse_id': 1,
            'warehouse_name': 'Main Warehouse',
            'quantity_on_hand': 100,
            'quantity_reserved': 20,
            'quantity_available': 80,
            'reorder_level': 50,
            'reorder_quantity': 200,
            'stock_status': 'ADEQUATE',
            'supplier_name': 'Tech Supplies Co',
            'supplier_code': 'SUP-001',
            'last_stock_check': '2024-02-05T08:00:00Z',
            'last_restock_date': '2024-01-15'
        },
        {
            'product_id': 2,
            'product_code': 'WGT-B-002',
            'product_name': 'Widget B',
            'category': 'Electronics',
            'unit_price': 49.99,
            'warehouse_id': 1,
            'warehouse_name': 'Main Warehouse',
            'quantity_on_hand': 35,
            'quantity_reserved': 10,
            'quantity_available': 25,
            'reorder_level': 50,
            'reorder_quantity': 150,
            'stock_status': 'REORDER_NEEDED',
            'supplier_name': 'Tech Supplies Co',
            'supplier_code': 'SUP-001',
            'last_stock_check': '2024-02-05T08:00:00Z',
            'last_restock_date': '2024-01-20'
        }
    ]), 200

@app.route('/api/analytics/sales-performance', methods=['GET'])
def get_sales_performance():
    """
    Sales Performance by Period
    ---
    tags:
      - Analytics
    parameters:
      - name: period
        in: query
        type: string
        required: false
        default: month
        enum: [day, week, month, quarter, year]
        description: Time period for grouping
      - name: start_date
        in: query
        type: string
        format: date
        required: false
      - name: end_date
        in: query
        type: string
        format: date
        required: false
    responses:
      200:
        description: Sales metrics grouped by time period
        schema:
          type: array
          items:
            type: object
            properties:
              period:
                type: string
              total_orders:
                type: integer
              unique_customers:
                type: integer
              gross_revenue:
                type: number
              net_revenue:
                type: number
              avg_order_value:
                type: number
    """
    period = request.args.get('period', 'month')
    
    return jsonify([
        {
            'period': '2024-02',
            'total_orders': 156,
            'unique_customers': 89,
            'gross_revenue': 425000.00,
            'total_discounts': 12500.00,
            'total_tax': 35000.00,
            'total_shipping': 7800.00,
            'net_revenue': 455300.00,
            'avg_order_value': 2918.59,
            'cancelled_orders': 5,
            'paid_amount': 440000.00,
            'unpaid_amount': 15300.00
        },
        {
            'period': '2024-01',
            'total_orders': 142,
            'unique_customers': 82,
            'gross_revenue': 385000.00,
            'total_discounts': 11000.00,
            'total_tax': 31500.00,
            'total_shipping': 7100.00,
            'net_revenue': 412600.00,
            'avg_order_value': 2905.63,
            'cancelled_orders': 3,
            'paid_amount': 400000.00,
            'unpaid_amount': 12600.00
        }
    ]), 200

@app.route('/api/analytics/product-performance', methods=['GET'])
def get_product_performance():
    """
    Product Performance Analysis
    ---
    tags:
      - Analytics
    parameters:
      - name: top_n
        in: query
        type: integer
        required: false
        default: 20
        description: Number of top products to return
    responses:
      200:
        description: Top performing products with profitability metrics
        schema:
          type: array
          items:
            type: object
            properties:
              product_id:
                type: integer
              product_name:
                type: string
              total_quantity_sold:
                type: integer
              total_revenue:
                type: number
              gross_profit:
                type: number
              profit_margin_pct:
                type: number
    """
    top_n = request.args.get('top_n', 20, type=int)
    
    return jsonify([
        {
            'product_id': 1,
            'product_code': 'WGT-A-001',
            'product_name': 'Widget A',
            'category': 'Electronics',
            'unit_price': 29.99,
            'cost_price': 15.00,
            'times_ordered': 145,
            'total_quantity_sold': 580,
            'total_revenue': 17394.20,
            'avg_selling_price': 29.99,
            'total_cost': 8700.00,
            'gross_profit': 8694.20,
            'profit_margin_pct': 50.00,
            'unique_customers': 78,
            'last_ordered_date': '2024-02-05'
        },
        {
            'product_id': 2,
            'product_code': 'WGT-B-002',
            'product_name': 'Widget B',
            'category': 'Electronics',
            'unit_price': 49.99,
            'cost_price': 25.00,
            'times_ordered': 98,
            'total_quantity_sold': 392,
            'total_revenue': 19596.08,
            'avg_selling_price': 49.99,
            'total_cost': 9800.00,
            'gross_profit': 9796.08,
            'profit_margin_pct': 50.00,
            'unique_customers': 65,
            'last_ordered_date': '2024-02-04'
        }
    ]), 200

@app.route('/api/analytics/order-fulfillment', methods=['GET'])
def get_order_fulfillment():
    """
    Order Fulfillment Metrics
    ---
    tags:
      - Analytics
    parameters:
      - name: start_date
        in: query
        type: string
        format: date
        required: false
      - name: end_date
        in: query
        type: string
        format: date
        required: false
    responses:
      200:
        description: Fulfillment and shipping performance metrics
        schema:
          type: array
          items:
            type: object
            properties:
              order_status:
                type: string
              order_count:
                type: integer
              avg_days_to_ship:
                type: number
              avg_days_to_deliver:
                type: number
              on_time_deliveries:
                type: integer
              late_deliveries:
                type: integer
    """
    return jsonify([
        {
            'order_status': 'completed',
            'order_count': 245,
            'avg_days_to_ship': 1.5,
            'avg_days_to_deliver': 4.2,
            'on_time_deliveries': 230,
            'late_deliveries': 15,
            'avg_shipping_cost': 15.50,
            'total_order_value': 685000.00,
            'warehouse_name': 'Main Warehouse',
            'warehouse_code': 'WH-001'
        },
        {
            'order_status': 'pending',
            'order_count': 45,
            'avg_days_to_ship': None,
            'avg_days_to_deliver': None,
            'on_time_deliveries': 0,
            'late_deliveries': 0,
            'avg_shipping_cost': 15.50,
            'total_order_value': 125000.00,
            'warehouse_name': 'Main Warehouse',
            'warehouse_code': 'WH-001'
        }
    ]), 200

@app.route('/api/analytics/customer-segmentation', methods=['GET'])
def get_customer_segmentation():
    """
    Customer Segmentation Analysis
    ---
    tags:
      - Analytics
    responses:
      200:
        description: Customers segmented by value and activity
        schema:
          type: array
          items:
            type: object
            properties:
              customer_id:
                type: integer
              company_name:
                type: string
              lifetime_value:
                type: number
              value_segment:
                type: string
                enum: [VIP, High Value, Medium Value, Low Value]
              activity_segment:
                type: string
                enum: [Active, At Risk, Dormant, Inactive]
    """
    return jsonify([
        {
            'customer_id': 1,
            'company_name': 'Acme Corp',
            'customer_type': 'corporate',
            'order_count': 125,
            'lifetime_value': 350000.00,
            'avg_order_value': 2800.00,
            'last_order_date': '2024-02-01',
            'days_since_last_order': 4,
            'outstanding_balance': 5000.00,
            'value_segment': 'VIP',
            'activity_segment': 'Active'
        },
        {
            'customer_id': 2,
            'company_name': 'Tech Solutions Inc',
            'customer_type': 'corporate',
            'order_count': 85,
            'lifetime_value': 185000.00,
            'avg_order_value': 2176.47,
            'last_order_date': '2024-01-15',
            'days_since_last_order': 21,
            'outstanding_balance': 2500.00,
            'value_segment': 'VIP',
            'activity_segment': 'Active'
        },
        {
            'customer_id': 3,
            'company_name': 'Small Business LLC',
            'customer_type': 'small_business',
            'order_count': 12,
            'lifetime_value': 15000.00,
            'avg_order_value': 1250.00,
            'last_order_date': '2023-11-20',
            'days_since_last_order': 77,
            'outstanding_balance': 0.00,
            'value_segment': 'Medium Value',
            'activity_segment': 'At Risk'
        }
    ]), 200

@app.route('/api/analytics/payment-collection', methods=['GET'])
def get_payment_collection():
    """
    Payment Collection Report
    ---
    tags:
      - Analytics
    responses:
      200:
        description: Accounts receivable and collection metrics
        schema:
          type: array
          items:
            type: object
            properties:
              customer_id:
                type: integer
              company_name:
                type: string
              total_outstanding:
                type: number
              overdue_amount:
                type: number
              credit_status:
                type: string
                enum: [GOOD, WARNING, CRITICAL]
    """
    return jsonify([
        {
            'customer_id': 1,
            'company_name': 'Acme Corp',
            'credit_limit': 50000.00,
            'total_invoices': 45,
            'total_invoiced': 125000.00,
            'total_collected': 120000.00,
            'total_outstanding': 5000.00,
            'overdue_invoices': 2,
            'overdue_amount': 2500.00,
            'avg_days_to_payment': 28,
            'latest_due_date': '2024-02-15',
            'credit_status': 'GOOD'
        },
        {
            'customer_id': 4,
            'company_name': 'Late Payer Inc',
            'credit_limit': 25000.00,
            'total_invoices': 18,
            'total_invoiced': 45000.00,
            'total_collected': 25000.00,
            'total_outstanding': 20000.00,
            'overdue_invoices': 8,
            'overdue_amount': 18000.00,
            'avg_days_to_payment': 65,
            'latest_due_date': '2024-01-10',
            'credit_status': 'CRITICAL'
        }
    ]), 200

@app.route('/api/analytics/warehouse-utilization', methods=['GET'])
def get_warehouse_utilization():
    """
    Warehouse Utilization Report
    ---
    tags:
      - Analytics
    responses:
      200:
        description: Warehouse capacity and utilization metrics
        schema:
          type: array
          items:
            type: object
            properties:
              warehouse_id:
                type: integer
              warehouse_name:
                type: string
              capacity:
                type: integer
              total_units_stored:
                type: integer
              utilization_pct:
                type: number
              orders_fulfilled:
                type: integer
    """
    return jsonify([
        {
            'warehouse_id': 1,
            'warehouse_code': 'WH-001',
            'warehouse_name': 'Main Warehouse',
            'location': 'New York, NY',
            'capacity': 100000,
            'unique_products': 450,
            'total_units_stored': 75000,
            'total_units_reserved': 12000,
            'total_units_available': 63000,
            'utilization_pct': 75.00,
            'orders_fulfilled': 1250,
            'shipments_sent': 1180,
            'manager_name': 'John Manager'
        },
        {
            'warehouse_id': 2,
            'warehouse_code': 'WH-002',
            'warehouse_name': 'West Coast Distribution',
            'location': 'Los Angeles, CA',
            'capacity': 80000,
            'unique_products': 380,
            'total_units_stored': 52000,
            'total_units_reserved': 8000,
            'total_units_available': 44000,
            'utilization_pct': 65.00,
            'orders_fulfilled': 890,
            'shipments_sent': 850,
            'manager_name': 'Jane Supervisor'
        }
    ]), 200

@app.route('/api/analytics/user-activity', methods=['GET'])
def get_user_activity():
    """
    User Activity Summary
    ---
    tags:
      - Analytics
    parameters:
      - name: start_date
        in: query
        type: string
        format: date
        required: false
      - name: end_date
        in: query
        type: string
        format: date
        required: false
    responses:
      200:
        description: CRM activity summary by user
        schema:
          type: array
          items:
            type: object
            properties:
              user_id:
                type: integer
              full_name:
                type: string
              total_activities:
                type: integer
              completed_activities:
                type: integer
              completion_rate_pct:
                type: number
    """
    return jsonify([
        {
            'user_id': 1,
            'username': 'jsmith',
            'full_name': 'John Smith',
            'role': 'sales_rep',
            'activity_type': 'call',
            'total_activities': 145,
            'completed_activities': 132,
            'pending_activities': 10,
            'cancelled_activities': 3,
            'completion_rate_pct': 91.03,
            'avg_days_to_complete': 2.5,
            'unique_customers_contacted': 45
        },
        {
            'user_id': 2,
            'username': 'mjones',
            'full_name': 'Mary Jones',
            'role': 'sales_rep',
            'activity_type': 'meeting',
            'total_activities': 98,
            'completed_activities': 85,
            'pending_activities': 12,
            'cancelled_activities': 1,
            'completion_rate_pct': 86.73,
            'avg_days_to_complete': 3.2,
            'unique_customers_contacted': 38
        }
    ]), 200

@app.route('/api/analytics/supplier-performance', methods=['GET'])
def get_supplier_performance():
    """
    Supplier Performance Report
    ---
    tags:
      - Analytics
    responses:
      200:
        description: Supplier performance metrics and ratings
        schema:
          type: array
          items:
            type: object
            properties:
              supplier_id:
                type: integer
              supplier_name:
                type: string
              rating:
                type: number
              products_supplied:
                type: integer
              total_sales_value:
                type: number
              avg_profit_per_unit:
                type: number
    """
    return jsonify([
        {
            'supplier_id': 1,
            'supplier_code': 'SUP-001',
            'supplier_name': 'Tech Supplies Co',
            'rating': 4.5,
            'payment_terms': 'Net 30',
            'products_supplied': 125,
            'inventory_locations': 3,
            'total_units_in_stock': 15000,
            'orders_containing_products': 450,
            'total_units_sold': 8500,
            'total_sales_value': 425000.00,
            'avg_profit_per_unit': 15.50,
            'last_restock_date': '2024-02-01'
        },
        {
            'supplier_id': 2,
            'supplier_code': 'SUP-002',
            'supplier_name': 'Global Electronics Ltd',
            'rating': 4.8,
            'payment_terms': 'Net 45',
            'products_supplied': 98,
            'inventory_locations': 2,
            'total_units_in_stock': 12000,
            'orders_containing_products': 380,
            'total_units_sold': 7200,
            'total_sales_value': 385000.00,
            'avg_profit_per_unit': 18.75,
            'last_restock_date': '2024-01-28'
        }
    ]), 200

@app.route('/api/analytics/revenue-forecast', methods=['GET'])
def get_revenue_forecast():
    """
    Revenue Forecast
    ---
    tags:
      - Analytics
    parameters:
      - name: months_ahead
        in: query
        type: integer
        required: false
        default: 3
        description: Number of months to forecast
    responses:
      200:
        description: Revenue forecast based on historical trends
        schema:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              revenue:
                type: number
              order_count:
                type: integer
              moving_avg_3month:
                type: number
              growth_rate_pct:
                type: number
    """
    return jsonify([
        {
            'month': '2024-02',
            'revenue': 455300.00,
            'order_count': 156,
            'avg_order_value': 2918.59,
            'moving_avg_3month': 438450.00,
            'growth_rate_pct': 10.35
        },
        {
            'month': '2024-01',
            'revenue': 412600.00,
            'order_count': 142,
            'avg_order_value': 2905.63,
            'moving_avg_3month': 425800.00,
            'growth_rate_pct': 7.15
        },
        {
            'month': '2023-12',
            'revenue': 385000.00,
            'order_count': 135,
            'avg_order_value': 2851.85,
            'moving_avg_3month': 398500.00,
            'growth_rate_pct': 5.50
        }
    ]), 200


if __name__ == '__main__':
    port = int(os.getenv('PORT', 5000))
    print(f"\n{'='*70}")
    print(f"ðŸš€ CRM & Inventory API with Swagger Documentation")
    print(f"{'='*70}")
    print(f"Server:        http://localhost:{port}")
    print(f"Swagger UI:    http://localhost:{port}/apidocs/")
    print(f"API Spec:      http://localhost:{port}/apispec.json")
    print(f"{'='*70}\n")
    
    app.run(host='0.0.0.0', port=port, debug=True)
